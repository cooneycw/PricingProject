{% extends "Pricing/base_enh.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% block content %}
    <main class="page landing-page">
        <section class="clean-block clean-info dark">
            <div class="container">
                <div class="block-heading" style="display: flex; align-items: center; justify-content: space-between;">
                    <h4 style="margin-right: 20px;font-weight: bold;color: #0a53be">Financial Statement Report</h4>
                    <form method="POST">
                        {% csrf_token %}
                        <input class="btn btn-outline-dark btn-lg action-button" type="Submit" name="Back to Dashboard" value="Back to Dashboard"></input>
                    </form>
                </div>
                {% if not has_financial_data %}
                    <div class="block-heading" style="text-align: left">
                        <p>Financial data processing not yet complete.  Please await notification in the Message Centre.</p>
                    </div>
                {% endif %}
                {% if has_financial_data %}
                        <div style="padding-left: 20px;  margin-bottom: 20px;"> <!-- Wrapper with padding for whitespace -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <form method="GET" action="" style="display: flex; align-items: center;">
                                    <div style="margin-right: 15px; width: 300px;">
                                        <label for="year">Latest Year for Display:</label>
                                    </div>
                                    <div style="margin-right: 15px; ">
                                        <select id="year" name="year" class="form-select form-select-sm">
                                            {% for year in unique_years %}
                                                <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <input type="submit" value="Select" class="btn btn-primary btn-sm">
                                </form>
                                <button id="toggleViewBtn" class="btn btn-primary btn-sm">Show Chart</button>
                            </div>
                            <hr>
                            <div class="financial-data-table" style="{{ initial_table_style|default:'display: block' }};">
                                {{ financial_data_table | safe }}
                            </div>
                            <div id="financialsChart" style="{{ initial_chart_style|default:'display: none' }};"></div>
                        </div>
                {% endif %}
            </div>
        </section>
    </main>
{% if has_financial_data %}
    {{ chart_data|json_script:"chartDataJson" }}
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Table cell formatting (as before)
        var tableRows = document.querySelectorAll('.financial-data-table tr');
        tableRows.forEach(function(row) {
            var cells = row.querySelectorAll('th, td');
            cells.forEach(function(cell) {
                if(cell.innerHTML.trim() === '') {
                    cell.innerHTML = '&nbsp;';
                }
                cell.style.fontFamily = "'Roboto Mono', monospace";
            });
        });

        // Toggle and Chart Logic
        const toggleButton = document.getElementById('toggleViewBtn');
        const tableContainer = document.querySelector('.financial-data-table');
        const chartContainer = document.getElementById('financialsChart');

        let isNoviceGame = false;
        try {
            isNoviceGame = JSON.parse("{{ is_novice_game|yesno:'true,false,null' }}");
        } catch (e) {
            console.error('Error parsing is_novice_game:', e);
            isNoviceGame = false;
        }

        let chartData = null;
        const chartDataElement = document.getElementById('chartDataJson');
        if (chartDataElement) {
            try {
                chartData = JSON.parse(chartDataElement.textContent);
            } catch (e) {
                chartData = null;
            }
        }

        // Determine current system's latest year
        let currentSystemLatestYear = null;
        if (chartData && chartData.years && chartData.years.length > 0) {
            // Assuming chartData.years contains numeric year values or strings convertible to numbers
            currentSystemLatestYear = Math.max(...chartData.years.map(y => parseInt(y, 10)).filter(y => !isNaN(y)));
        }
        if (isNaN(currentSystemLatestYear) || currentSystemLatestYear === null || currentSystemLatestYear === -Infinity) { // Fallback or if chartData.years was empty/invalid
            const yearOptions = Array.from(document.querySelectorAll('#year option'))
                                     .map(opt => parseInt(opt.value, 10))
                                     .filter(y => !isNaN(y));
            if (yearOptions.length > 0) {
                currentSystemLatestYear = Math.max(...yearOptions);
            }
        }
        // Ensure currentSystemLatestYear is null if no valid year was found
        if (currentSystemLatestYear === -Infinity || isNaN(currentSystemLatestYear)) {
            currentSystemLatestYear = null;
        }

        function setButtonState(showChart) {
            if (toggleButton) {
                if (showChart) {
                    toggleButton.textContent = 'Show Table';
                    toggleButton.classList.remove('btn-primary');
                    toggleButton.classList.add('btn-warning');
                } else {
                    toggleButton.textContent = 'Show Chart';
                    toggleButton.classList.remove('btn-warning');
                    toggleButton.classList.add('btn-primary');
                }
            }
        }

        function setViewVisibility(showChart) {
            if (showChart) {
                if (tableContainer) tableContainer.style.display = 'none';
                if (chartContainer) chartContainer.style.display = 'block';
            } else {
                if (tableContainer) tableContainer.style.display = 'block';
                if (chartContainer) chartContainer.style.display = 'none';
            }
            setButtonState(showChart);
        }

        // Function to update localStorage and return the view state (true for chart, false for table)
        function getAndManageStoredFinancialsView(currentLatestYearFromSystem, isNoviceUser) {
            let storedViewPref = localStorage.getItem('financialsView');
            let storedLatestYear = localStorage.getItem('financialsLatestYear') ? parseInt(localStorage.getItem('financialsLatestYear'), 10) : null;
            let showChart;

            if (currentLatestYearFromSystem !== null && (storedLatestYear === null || currentLatestYearFromSystem > storedLatestYear)) {
                // New data year detected or first time with year logic for this report
                showChart = true; // Default to chart
                localStorage.setItem('financialsView', 'chart');
                localStorage.setItem('financialsLatestYear', currentLatestYearFromSystem.toString());
            } else if (storedViewPref) {
                // Use existing preference as no new year forces a change
                showChart = (storedViewPref === 'chart');
                // If storedLatestYear was somehow not set but viewPref was, and we have a current year, set it now
                if (storedLatestYear === null && currentLatestYearFromSystem !== null) {
                    localStorage.setItem('financialsLatestYear', currentLatestYearFromSystem.toString());
                }
            } else {
                // No stored preference, and no new year forcing a change - use novice status
                showChart = isNoviceUser;
                localStorage.setItem('financialsView', showChart ? 'chart' : 'table');
                if (currentLatestYearFromSystem !== null) {
                    localStorage.setItem('financialsLatestYear', currentLatestYearFromSystem.toString());
                }
            }
            return showChart;
        }

        let showChartsInitialState = getAndManageStoredFinancialsView(currentSystemLatestYear, isNoviceGame);

        if (tableContainer && chartContainer && toggleButton) {
            setViewVisibility(showChartsInitialState);
        }

        if (chartData && chartData.years && chartData.years.length > 0) {
            var options = {
                series: [
                    { name: 'Written Premium', type: 'line', data: chartData.written_premium },
                    { name: 'Capital', type: 'line', data: chartData.capital }
                ],
                chart: {
                    height: 350,
                    type: 'line',
                    toolbar: { show: true }
                },
                colors: ['#008FFB', '#00E396'],
                stroke: { width: [3, 3], curve: 'smooth' },
                title: { text: 'Written Premium vs Capital (Last 20 Years)' },
                xaxis: {
                    categories: chartData.years,
                    title: { text: 'Year' }
                },
                yaxis: [
                    {
                        seriesName: 'Written Premium',
                        title: { text: 'Written Premium' },
                        labels: { formatter: function (value) { return "$" + Math.round(value).toLocaleString(); } },
                        tickAmount: 5,
                        min: 0
                    },
                    {
                        seriesName: 'Capital',
                        opposite: true,
                        title: { text: 'Capital' },
                        labels: { formatter: function (value) { return "$" + Math.round(value).toLocaleString(); } },
                        tickAmount: 5,
                        min: 0
                    }
                ],
                legend: { show: true, position: 'bottom', horizontalAlign: 'center' },
                tooltip: {
                    shared: true, intersect: false,
                    y: {
                        formatter: function (val, { seriesIndex, w }) {
                            if (val === undefined || val === null) return 'N/A';
                            return "$" + Math.round(val).toLocaleString();
                        }
                    }
                }
            };
            var chart = new ApexCharts(chartContainer, options);
            chart.render();
        } else {
            if (toggleButton) toggleButton.style.display = 'none';
            if (chartContainer) chartContainer.style.display = 'none';
        }

        if (toggleButton) {
            toggleButton.addEventListener('click', function() {
                const isChartVisible = chartContainer && chartContainer.style.display === 'block';
                const newViewIsCharts = !isChartVisible;
                setViewVisibility(newViewIsCharts);

                localStorage.setItem('financialsView', newViewIsCharts ? 'chart' : 'table');
                if (currentSystemLatestYear !== null) {
                    localStorage.setItem('financialsLatestYear', currentSystemLatestYear.toString());
                }
            });
        }
    });
    </script>
{% endif %}
{% endblock content %}
