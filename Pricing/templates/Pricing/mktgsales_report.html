{% extends "Pricing/base_enh.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% block content %}
    <main class="page landing-page">
        <section class="clean-block clean-info dark">
            <div class="container">
                <div class="block-heading" style="display: flex; align-items: center; justify-content: space-between;">
                    <h4 style="margin-right: 20px;font-weight: bolder; color: #0a53be">Marketing / Sales Report</h4>
                    <form method="POST" style="margin-left: auto; margin-right: 10px;">
                        {% csrf_token %}
                        <input class="btn btn-outline-dark btn-lg action-button" type="Submit" name="Back to Dashboard" value="Back to Dashboard">
                    </form>
                </div>
                {% if not has_financial_data %}
                    <div class="block-heading" style="text-align: left">
                        <p>Marketing / Sales data processing not yet complete.  Please await notification in the Message Centre.</p>
                    </div>
                {% endif %}
                {% if has_financial_data %}
                        <div style="padding-left: 20px;  margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <form method="GET" action="" style="display: flex; align-items: center;">
                                    <div style="margin-right: 15px; width: auto;">
                                        <label for="year" style="margin-right: 5px;">Latest Year for Display:</label>
                                    </div>
                                    <div style="margin-right: 15px; ">
                                        <select id="year" name="year" class="form-select form-select-sm">
                                            {% for year in unique_years %}
                                                <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <input type="submit" value="Select" class="btn btn-primary btn-sm">
                                </form>
                                <button id="toggleViewBtn" class="btn btn-primary btn-sm">Show Chart</button>
                            </div>
                            <hr>
                            <div class="mktgsales-data-table" style="{{ initial_table_style|default:'display: block' }};">
                                {{ financial_data_table|safe }}
                            </div>
                            <div id="activityChart" style="{{ initial_chart_style|default:'display: none' }};"></div>
                            <div id="financialRatioChart" style="{{ initial_chart_style|default:'display: none' }}; margin-top: 20px;"></div>
                            <div id="ratiosChart" style="{{ initial_chart_style|default:'display: none' }}; margin-top: 20px;"></div>
                            
                            <!-- Color Guide -->
                            <div id="colorGuide" style="{{ initial_chart_style|default:'display: none' }}; margin: 20px 0; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: #fafafa;">
                                <div style="font-weight: bold; margin-bottom: 10px;">Industry Health Indicators:</div>
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <div style="display: flex; align-items: center;">
                                        <span style="display: inline-block; width: 20px; height: 20px; background: #00E396; border-radius: 50%; margin-right: 8px;"></span>
                                        <span>Healthy</span>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <span style="display: inline-block; width: 20px; height: 20px; background: #FEB019; border-radius: 50%; margin-right: 8px;"></span>
                                        <span>Caution</span>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <span style="display: inline-block; width: 20px; height: 20px; background: #FF6347; border-radius: 50%; margin-right: 8px;"></span>
                                        <span>Warning</span>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <span style="display: inline-block; width: 20px; height: 20px; background: #FF4560; border-radius: 50%; margin-right: 8px;"></span>
                                        <span>Critical</span>
                                    </div>
                                    <div style="margin-left: 20px; display: flex; align-items: center;">
                                        <span style="display: inline-block; width: 24px; height: 24px; background: #ccc; border: 2px solid #000; border-radius: 50%; margin-right: 8px;"></span>
                                        <span>Product Reform Year</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="scatterChart" style="{{ initial_chart_style|default:'display: none' }}; margin-top: 20px;"></div>
                        </div>

                {% endif %}
            </div>
        </section>
    </main>
 {{ chart_data|json_script:"chartDataJson" }}
 <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
 <script>
    console.log("MktgSales Report SCRIPT START");
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded event fired.");
        // Select all table rows within the financial-data-table
        var tableRows = document.querySelectorAll('.mktgsales-data-table tr');

        // Loop through each table row
        tableRows.forEach(function(row) {
            // Select all th and td elements in the current row
            var cells = row.querySelectorAll('th, td');

            // Loop through each cell
            cells.forEach(function(cell) {
                // Check if the cell is empty
                if(cell.innerHTML.trim() === '') {
                    // If empty, insert a non-breaking space character
                    cell.innerHTML = '&nbsp;';
                }

                // Apply the monospaced font to each cell
                cell.style.fontFamily = "'Roboto Mono', monospace";  // Replace 'Roboto Mono' with your chosen font
            });
        });

        // Chart and Toggle Logic
        const toggleButton = document.getElementById('toggleViewBtn');
        const tableContainer = document.querySelector('.mktgsales-data-table');
        const activityChartContainer = document.getElementById('activityChart'); 
        const financialRatioChartContainer = document.getElementById('financialRatioChart'); 
        const ratiosChartContainer = document.getElementById('ratiosChart'); // New chart container
        const scatterChartContainer = document.getElementById('scatterChart'); // Scatter chart container

        let isNoviceGame = false;
        try {
            isNoviceGame = JSON.parse("{{ is_novice_game|yesno:'true,false,null' }}");
        } catch (e) {
            console.error('Error parsing is_novice_game:', e);
        }

        let chartData;
        const chartDataElement = document.getElementById('chartDataJson');
        if (chartDataElement) {
            try {
                chartData = JSON.parse(chartDataElement.textContent);
                console.log('DEBUG: Successfully parsed chartData:', chartData);
                console.log('DEBUG: chartData has scatter_data?', chartData.scatter_data ? 'Yes' : 'No');
            } catch (e) {
                console.error('Error parsing chart_data from json_script:', e);
                if (toggleButton) toggleButton.style.display = 'none';
                if (activityChartContainer) activityChartContainer.style.display = 'none';
                if (financialRatioChartContainer) financialRatioChartContainer.style.display = 'none';
                if (ratiosChartContainer) ratiosChartContainer.style.display = 'none';
                if (scatterChartContainer) scatterChartContainer.style.display = 'none';
                return;
            }
        } else if ("{{chart_data}}" === "None" || "{{chart_data}}" === "") {
             console.log('chart_data was None or empty in Django context, chartData will remain null.');
        }

        // Placeholder for OSFI failure data - this should be populated from your Django view
        // Example structure: {'2023': ['CompanyA', 'CompanyB'], '2022': ['CompanyC']}
        let osfiFailureData = {}; 
        const osfiDataElement = document.getElementById('osfiFailureDataJson');
        if (osfiDataElement) {
            try {
                osfiFailureData = JSON.parse(osfiDataElement.textContent);
            } catch (e) {
                console.error('Error parsing osfi_failure_data from json_script:', e);
                // Decide if you want to hide charts or just proceed without OSFI annotations
            }
        }

        function setButtonState(showChart) {
            if (toggleButton) {
                if (showChart) {
                    toggleButton.textContent = 'Show Table';
                    toggleButton.classList.remove('btn-primary');
                    toggleButton.classList.add('btn-warning');
                } else {
                    toggleButton.textContent = 'Show Chart';
                    toggleButton.classList.remove('btn-warning');
                    toggleButton.classList.add('btn-primary');
                }
            }
        }

        if (isNoviceGame) {
            console.log('Novice game: Initial HTML should reflect chart-first view.');
            setButtonState(true);
        } else {
            console.log('Non-novice game: Initial HTML should reflect table-first view.');
            setButtonState(false); 
        }

        if (chartData && chartData.years && chartData.years.length > 0) {
            console.log('Chart data is valid. Proceeding with chart setup.');

            // Helper function to calculate Y-axis max with padding
            function getAxisMax(dataArray, paddingPercent = 0.1) {
                if (!dataArray || dataArray.length === 0) return undefined; 
                const numericArray = dataArray.map(val => Number(val)).filter(val => !isNaN(val));
                if (numericArray.length === 0) return undefined;
                const maxVal = Math.max(...numericArray);
                return maxVal * (1 + paddingPercent);
            }
            
            // Calculate max values for Y-axes - REORGANIZED
            const customersMaxChart1 = getAxisMax(chartData.customers);
            const avgPremiumMaxChart1 = getAxisMax(chartData.average_premium);
            // const cancellationsMaxChart1 = getAxisMax(chartData.cancellations); // No longer needed for chart 1

            const mktgSpendPercentMaxChart2 = getAxisMax(chartData.marketing_spend_percent_industry);
            // const quotesMaxChart2 = getAxisMax(chartData.quotes); // Will be part of activityCountsMaxChart2
            // const salesMaxChart2 = getAxisMax(chartData.sales); // Will be part of activityCountsMaxChart2
            const activityCountsMaxChart2 = getAxisMax([...(chartData.quotes || []), ...(chartData.sales || []), ...(chartData.cancellations || [])]); // Added cancellations

            // Max values for Chart 3 (Ratios)
            const avgPremiumMaxChart3 = getAxisMax(chartData.average_premium);
            const cancellationRateMaxChart3 = getAxisMax(chartData.cancellation_rate);
            const salesRatioMaxChart3 = getAxisMax(chartData.sales_ratio);
            const percentRatioMaxChart3 = getAxisMax([...(chartData.cancellation_rate || []), ...(chartData.sales_ratio || [])]);

            const commonXAxis = {
                categories: chartData.years,
                title: { text: 'Year' },
                labels: {
                    style: {
                        fontSize: '12px'
                    }
                },
                axisBorder: {
                    show: true
                },
                axisTicks: {
                    show: true
                }
            };
            
            const commonChartProps = {
                height: 350,
                type: 'line',
                toolbar: { show: true },
                group: 'mktgSalesCharts' // Synchronization group
            };

            // Common grid configuration to ensure consistent chart area
            const commonGrid = {
                padding: {
                    left: 10,
                    right: 10
                }
            };

            // --- Chart 1: Activity Metrics (Customers, Average Premium) ---
            var options1 = {
                series: [{
                    name: 'Customers', type: 'line', data: chartData.customers
                }, {
                    name: 'Average Premium', type: 'line', data: chartData.average_premium
                }/*, { // Removed Cancellations
                    name: 'Cancellations', type: 'line', data: chartData.cancellations
                }*/],
                chart: commonChartProps,
                colors: ['#00E396', '#FF0000'/*, '#5400E0'*/], // Green (Cust), Red (Avg Prem) - Removed Purple (Canx)
                stroke: { width: [3, 3/*, 2*/], curve: 'smooth' }, // Removed width for Cancellations
                title: { text: 'Customer & Financial Overview' },
                xaxis: commonXAxis,
                grid: commonGrid,
                yaxis: [
                    {
                        seriesName: 'Customers',
                        title: { text: 'Customers' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? Math.round(value).toLocaleString() : ''; } },
                        tickAmount: 5,
                        min: 0,
                        max: customersMaxChart1
                    },
                    {
                        seriesName: 'Average Premium',
                        opposite: true,
                        title: { text: 'Average Premium ($' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? "$" + Math.round(value).toLocaleString() : ''; } },
                        tickAmount: 5,
                        max: avgPremiumMaxChart1
                    }/*, // Removed Y-axis for Cancellations
                    {
                        seriesName: 'Cancellations',
                        opposite: true,
                        title: { text: 'Cancellations' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? Math.round(value).toLocaleString() : ''; } },
                        tickAmount: 5,
                        min: 0,
                        max: cancellationsMaxChart1,
                        show: true
                    }*/
                ],
                legend: { show: true, position: 'bottom', horizontalAlign: 'center' },
                tooltip: {
                    shared: true, intersect: false,
                    y: {
                        formatter: function (val, { seriesIndex, w }) {
                            const seriesName = w.globals.seriesNames[seriesIndex];
                            if (val === undefined || val === null) return 'N/A';
                            if (seriesName === 'Customers') return Math.round(val).toLocaleString() + " Customers";
                            if (seriesName === 'Average Premium') return "$" + Math.round(val).toLocaleString();
                            // if (seriesName === 'Cancellations') return Math.round(val).toLocaleString() + " Cancellations"; // Removed
                            return Math.round(val).toLocaleString();
                        }
                    }
                }
            };

            // --- Chart 2: Marketing & Sales Activity (Mktg Spend %, Quotes, Sales, Cancellations) ---
            var options2 = {
                series: [{
                    name: 'Mktg Spend (% of Industry)', type: 'column', data: chartData.marketing_spend_percent_industry
                }, {
                    name: 'Quotes', type: 'line', data: chartData.quotes
                }, {
                    name: 'Sales', type: 'line', data: chartData.sales
                }, {
                    name: 'Cancellations', type: 'line', data: chartData.cancellations
                }],
                chart: commonChartProps,
                colors: ['#008FFB', '#00E396', '#FF4560', '#FEB019'], // Mktg:Blue, Quotes:Green, Sales:Red, Canx:Orange
                stroke: { width: [0, 3, 3, 2], curve: 'smooth' },
                title: { text: 'Marketing & Sales Activity' },
                xaxis: commonXAxis,
                grid: commonGrid,
                plotOptions: {
                    bar: {
                        columnWidth: '40%', // Control column width to prevent x-axis expansion
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                yaxis: [
                    {
                        seriesName: ['Quotes', 'Sales', 'Cancellations'],
                        title: { text: 'Quotes / Sales / Cancellations' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? Math.round(value).toLocaleString() : ''; } },
                        tickAmount: 5,
                        min: 0,
                        max: activityCountsMaxChart2
                    },
                    {
                        seriesName: 'Mktg Spend (% of Industry)',
                        opposite: true,
                        title: { text: 'Mktg Spend (% of Industry)' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? value.toFixed(1) + "%" : ''; } },
                        tickAmount: 5,
                        min: 0, // Always start at 0
                        max: mktgSpendPercentMaxChart2
                    }
                ],
                legend: { show: true, position: 'bottom', horizontalAlign: 'center', itemMargin: { horizontal: 5, vertical: 0 } },
                tooltip: {
                    shared: true, intersect: false,
                    y: {
                        formatter: function (val, { seriesIndex, w }) {
                            const seriesName = w.globals.seriesNames[seriesIndex];
                            if (val === undefined || val === null) return 'N/A';
                            if (seriesName === 'Mktg Spend (% of Industry)') return val.toFixed(1) + "%";
                            if (seriesName === 'Quotes') return Math.round(val).toLocaleString() + " Quotes";
                            if (seriesName === 'Sales') return Math.round(val).toLocaleString() + " Sales";
                            if (seriesName === 'Cancellations') return Math.round(val).toLocaleString() + " Cancellations";
                            return Math.round(val).toLocaleString();
                        }
                    }
                },
                annotations: { // Added annotations for OSFI failures
                    xaxis: [] // Will be populated dynamically
                }
            };
            
            // Dynamically add OSFI failure annotations to options2
            if (chartData && chartData.years && Object.keys(osfiFailureData).length > 0) {
                chartData.years.forEach((year, index) => {
                    if (osfiFailureData[year] && osfiFailureData[year].length > 0) {
                        options2.annotations.xaxis.push({
                            x: year, // Category name
                            // y: 0, // Y-coordinate on the y-axis, adjust if needed
                            borderColor: '#FF0000', // Red border for emphasis
                            label: {
                                borderColor: '#FF0000',
                                style: {
                                    color: '#fff', // White text
                                    background: '#FF0000', // Red background
                                    fontSize: '10px',
                                    fontFamily: 'Arial, sans-serif',
                                    cssClass: 'apexcharts-xaxis-annotation-label',
                                },
                                text: 'OSFI Failures: ' + osfiFailureData[year].join(', '),
                                orientation: 'horizontal', // Ensure label is horizontal
                                offsetY: 5, // Position below the x-axis line a bit more
                                position: 'bottom'
                            }
                        });
                    }
                });
            }

            // --- Chart 3: Ratio Analysis ---
            var options3 = {
                series: [{
                    name: 'Average Premium', type: 'line', data: chartData.average_premium
                }, {
                    name: 'Cancellation Rate (%)', type: 'line', data: chartData.cancellation_rate
                }, {
                    name: 'Sales Ratio (%)', type: 'line', data: chartData.sales_ratio
                }],
                chart: commonChartProps, // Re-use common properties
                colors: ['#FF0000', '#00CED1', '#FFD700'], // Red (Avg Prem), Turquoise (Cancel Rate), Gold (Sales Ratio)
                stroke: { width: [3, 2, 2], curve: 'smooth' },
                title: { text: 'Key Performance Ratios' },
                xaxis: commonXAxis,
                grid: commonGrid,
                yaxis: [
                    {
                        seriesName: 'Average Premium',
                        title: { text: 'Average Premium ($' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? "$" + Math.round(value).toLocaleString() : ''; } },
                        tickAmount: 5,
                        min: 0, // Assuming avg premium should start at 0 for this context, adjust if not
                        max: avgPremiumMaxChart3
                    },
                    {
                        seriesName: ['Cancellation Rate (%)', 'Sales Ratio (%)'],
                        opposite: true,
                        title: { text: 'Rate / Ratio (%)' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? value.toFixed(1) + "%" : ''; } },
                        tickAmount: 5,
                        min: 0, // Percentages typically start at 0
                        max: percentRatioMaxChart3 
                    }
                ],
                legend: { show: true, position: 'bottom', horizontalAlign: 'center', itemMargin: { horizontal: 5, vertical: 0 } },
                tooltip: {
                    shared: true, intersect: false,
                    y: {
                        formatter: function (val, { seriesIndex, w }) {
                            const seriesName = w.globals.seriesNames[seriesIndex];
                            if (val === undefined || val === null) return 'N/A';
                            if (seriesName === 'Average Premium') return "$" + Math.round(val).toLocaleString();
                            if (seriesName === 'Cancellation Rate (%)') return val.toFixed(1) + "%";
                            if (seriesName === 'Sales Ratio (%)') return val.toFixed(1) + "%";
                            return val.toLocaleString(); // Fallback, though unlikely needed with explicit series
                        }
                    }
                }
            };

            var chart1 = null;
            if (activityChartContainer) {
                chart1 = new ApexCharts(activityChartContainer, options1);
            }
            var chart2 = null;
            if (financialRatioChartContainer) {
                chart2 = new ApexCharts(financialRatioChartContainer, options2);
            }
            var chart3 = null; // New chart object
            if (ratiosChartContainer) {
                chart3 = new ApexCharts(ratiosChartContainer, options3);
            }

            // --- Chart 4: Rate Impact Scatter Plot ---
            var chart4 = null;
            
            if (scatterChartContainer && chartData.scatter_data && chartData.scatter_data.length > 0) {
                console.log('DEBUG: scatter_data exists with', chartData.scatter_data.length, 'points');
                console.log('DEBUG: First scatter point:', chartData.scatter_data[0]);
                
                // Prepare data for scatter plot
                const retentionData = [];
                const closeRatioData = [];
                
                // Color coding based on OSFI interventions
                const getColor = (interventions) => {
                    if (interventions === 0) return '#00E396'; // Green
                    if (interventions === 1) return '#FEB019'; // Yellow
                    if (interventions === 2) return '#FF6347'; // Orange
                    return '#FF4560'; // Red for 3+
                };
                
                // Skip the first 5 points when preparing the data
                chartData.scatter_data.slice(5).forEach(point => {
                    // Use the color function directly with OSFI interventions
                    const pointColor = getColor(point.osfi_interventions);
                    
                    const scatterPoint = {
                        x: point.combined_expense, // Changed from rate_increase
                        y: point.close_ratio,
                        fillColor: pointColor,
                        strokeColor: point.product_reforms ? '#000000' : pointColor,
                        markerSize: point.product_reforms ? 12 : 8,
                        strokeWidth: point.product_reforms ? 2 : 0,
                        // Include metadata for tooltip
                        year: point.year,
                        osfi_interventions: point.osfi_interventions,
                        product_reforms: point.product_reforms
                    };
                    
                    closeRatioData.push(scatterPoint);
                    
                    retentionData.push({
                        x: point.combined_expense, // Changed from rate_increase
                        y: point.retention_ratio,
                        fillColor: pointColor,
                        strokeColor: point.product_reforms ? '#000000' : pointColor,
                        markerSize: point.product_reforms ? 12 : 8,
                        strokeWidth: point.product_reforms ? 2 : 0,
                        // Include metadata for tooltip
                        year: point.year,
                        osfi_interventions: point.osfi_interventions,
                        product_reforms: point.product_reforms
                    });
                });
                
                console.log('DEBUG: retentionData length:', retentionData.length);
                console.log('DEBUG: closeRatioData length:', closeRatioData.length);
                console.log('DEBUG: Sample retention point:', retentionData[0]);
                console.log('DEBUG: X-axis range in data:', 
                    'min=', Math.min(...retentionData.map(p => p.x)),
                    'max=', Math.max(...retentionData.map(p => p.x)));
                console.log('DEBUG: Y-axis range in retention data:', 
                    'min=', Math.min(...retentionData.map(p => p.y)),
                    'max=', Math.max(...retentionData.map(p => p.y)));
                console.log('DEBUG: First 3 retention data points:', JSON.stringify(retentionData.slice(0, 3)));
                console.log('DEBUG: First 3 close ratio data points:', JSON.stringify(closeRatioData.slice(0, 3)));
                console.log('DEBUG: Close ratio curve length:', chartData.close_ratio_curve ? chartData.close_ratio_curve.length : 0);
                console.log('DEBUG: Retention ratio curve length:', chartData.retention_ratio_curve ? chartData.retention_ratio_curve.length : 0);
                if (chartData.close_ratio_curve && chartData.close_ratio_curve.length > 0) {
                    console.log('DEBUG: First 3 close curve points:', JSON.stringify(chartData.close_ratio_curve.slice(0, 3)));
                }
                
                // Test with simple data first
                console.log('DEBUG: Testing with first 5 close ratio points only');
                const testCloseData = closeRatioData.slice(0, 5);
                console.log('DEBUG: Test data:', JSON.stringify(testCloseData));
                
                // Create a simple test chart first
                console.log('Creating minimal test chart...');
                const testOptions = {
                    series: [{
                        name: 'Test Series',
                        data: [{x: 1, y: 10}, {x: 2, y: 20}, {x: 3, y: 15}, {x: 4, y: 25}, {x: 5, y: 30}]
                    }],
                    chart: {
                        height: 350,
                        type: 'scatter',
                    },
                    xaxis: {
                        type: 'numeric'
                    },
                    yaxis: {
                        type: 'numeric'
                    }
                };
                
                var options4 = {
                    series: [
                        { name: 'Close Ratio', type: 'scatter', data: closeRatioData },
                        { name: 'Retention Ratio', type: 'scatter', data: retentionData },
                        { name: 'Close Ratio Trend', type: 'line', data: chartData.close_ratio_curve || [] },
                        { name: 'Retention Ratio Trend', type: 'line', data: chartData.retention_ratio_curve || [] }
                    ],
                    chart: {
                        height: 350,
                        type: 'line',  // Change to 'line' for mixed chart
                        toolbar: { show: true },
                        zoom: { enabled: true, type: 'xy' }
                    },
                    stroke: {
                        curve: ['straight', 'straight', 'smooth', 'smooth'],  // Straight for scatter, smooth for regression lines
                        width: [0, 0, 2, 2],  // No line for scatter points, width 2 for regression lines
                        dashArray: [0, 0, 0, 0]  // No dashes
                    },
                    colors: ['#FF4560', '#00E396', '#FF4560', '#00E396'], // Red for close, green for retention
                    title: { text: 'Impact of Profit Margin + Marketing Expense on Close & Retention Ratios' },
                    xaxis: {
                        title: { text: 'Profit Margin + Marketing Expense (%)' },
                        type: 'numeric',
                        min: 0,  // Start from 0% 
                        max: 30, // Up to 30% for combined expense
                        labels: { formatter: val => val.toFixed(1) + '%' },
                        tickAmount: 6 // Show ticks at 0, 6, 12, 18, 24, 30
                    },
                    yaxis: {
                        title: { text: 'Ratio (%)' },
                        labels: {
                            formatter: function(val) {
                                return val !== undefined && val !== null ? val.toFixed(1) + '%' : '';
                            }
                        }
                    },
                    grid: {
                        xaxis: { lines: { show: true } },
                        yaxis: { lines: { show: true } }
                    },
                    markers: {
                        size: [8, 8, 0, 0],  // Size for each series: scatter points 8, lines 0
                        strokeWidth: [1, 1, 0, 0],  // Stroke width for each series
                        hover: {
                            sizeOffset: 3
                        }
                    },
                    dataLabels: {
                        enabled: false  // Turn on temporarily to debug
                    },
                    legend: { 
                        show: true, 
                        position: 'top',
                        horizontalAlign: 'left',
                        markers: { width: 12, height: 12 }
                    },
                    tooltip: {
                        custom: function({ series, seriesIndex, dataPointIndex, w }) {
                            const point = w.config.series[seriesIndex].data[dataPointIndex];
                            const seriesName = w.globals.seriesNames[seriesIndex];
                            
                            let tooltipHtml = '<div style="padding: 10px; font-size: 12px;">';
                            tooltipHtml += '<div>Year: ' + (point.year || 'N/A') + '</div>';
                            tooltipHtml += '<div>Profit + Marketing: ' + point.x.toFixed(1) + '%</div>';
                            tooltipHtml += '<div>' + seriesName + ': ' + point.y.toFixed(1) + '%</div>';
                            tooltipHtml += '<div style="margin-top: 5px; padding-top: 5px; border-top: 1px solid #ddd;">';
                            tooltipHtml += '<div>Industry MCT Failures: ' + (point.osfi_interventions || 0) + '</div>';
                            tooltipHtml += '<div>Product Reforms: ' + (point.product_reforms ? point.product_reforms : 'None') + '</div>';
                            tooltipHtml += '</div></div>';
                            
                            return tooltipHtml;
                        }
                    }
                };
                
                // Add a custom legend for OSFI intervention colors
                const legendContainer = document.createElement('div');
                legendContainer.style.cssText = 'margin-top: 10px; font-size: 12px; display: flex; gap: 20px; flex-wrap: wrap;';
                legendContainer.innerHTML = `
                    <div><strong>Industry MCT Failures:</strong></div>
                    <div><span style="display:inline-block;width:12px;height:12px;background:#00E396;border-radius:50%;"></span> 0 (None)</div>
                    <div><span style="display:inline-block;width:12px;height:12px;background:#FEB019;border-radius:50%;"></span> 1</div>
                    <div><span style="display:inline-block;width:12px;height:12px;background:#FF6347;border-radius:50%;"></span> 2</div>
                    <div><span style="display:inline-block;width:12px;height:12px;background:#FF4560;border-radius:50%;"></span> 3+</div>
                    <div style="margin-left: 20px;"><strong>Product Reforms:</strong></div>
                    <div><span style="display:inline-block;width:12px;height:12px;background:#ccc;border:2px solid #000;border-radius:50%;"></span> BI/CL/Both (larger)</div>
                `;
                scatterChartContainer.appendChild(legendContainer);
                
                chart4 = new ApexCharts(scatterChartContainer, options4);
                console.log('DEBUG: Chart 4 created with options:', options4);
                console.log('DEBUG: Series data lengths - retention:', options4.series[0].data.length, 'close:', options4.series[1].data.length);
                
                // Try creating test chart temporarily
                // const testChart = new ApexCharts(scatterChartContainer, testOptions);
                // testChart.render().then(() => console.log('Test chart rendered successfully'));
            } else {
                console.log('DEBUG: Scatter chart NOT created. Reasons:');
                console.log('  - scatterChartContainer:', scatterChartContainer ? 'exists' : 'missing');
                console.log('  - chartData.scatter_data:', chartData && chartData.scatter_data ? 'exists' : 'missing');
                console.log('  - scatter_data length:', chartData && chartData.scatter_data ? chartData.scatter_data.length : 'N/A');
            }

            function setViewVisibility(showCharts) {
                if (showCharts) {
                    if (tableContainer) tableContainer.style.display = 'none';
                    if (activityChartContainer) activityChartContainer.style.display = 'block';
                    if (financialRatioChartContainer) financialRatioChartContainer.style.display = 'block';
                    if (ratiosChartContainer) ratiosChartContainer.style.display = 'block';
                    if (scatterChartContainer) scatterChartContainer.style.display = 'block';
                    if (document.getElementById('colorGuide')) document.getElementById('colorGuide').style.display = 'block';
                } else {
                    if (tableContainer) tableContainer.style.display = 'block';
                    if (activityChartContainer) activityChartContainer.style.display = 'none';
                    if (financialRatioChartContainer) financialRatioChartContainer.style.display = 'none';
                    if (ratiosChartContainer) ratiosChartContainer.style.display = 'none';
                    if (scatterChartContainer) scatterChartContainer.style.display = 'none';
                    if (document.getElementById('colorGuide')) document.getElementById('colorGuide').style.display = 'none';
                }
                setButtonState(showCharts);
            }

            // Render all available charts
            const chartsToRender = [chart1, chart2, chart3, chart4].filter(chart => chart !== null);
            
            if (chartsToRender.length > 0) {
                Promise.all(chartsToRender.map(chart => chart.render())).then(() => {
                    console.log(`All ${chartsToRender.length} charts rendered successfully.`);
                    try {
                        // chart1.hideSeries('Cancellations'); // Cancellations no longer in chart1
                        chart2.hideSeries('Sales');
                        chart2.hideSeries('Cancellations'); // Hide Cancellations by default in Chart 2
                        // chart3.hideSeries('SeriesNameToHideByDefault'); // If any series in chart3 needs to be hidden by default
                        if (chart4) {
                            chart4.hideSeries('Retention Ratio'); // Hide Retention Ratio by default
                            chart4.hideSeries('Close Ratio Trend'); // Hide Close Ratio Trend by default
                            chart4.hideSeries('Retention Ratio Trend'); // Hide Retention Ratio Trend by default
                            console.log('Retention Ratio and trend lines hidden by default in scatter plot.');
                        }
                        console.log('Sales and Cancellations (Chart 2) series hidden by default.');
                    } catch (e) {
                        console.error('Error hiding series by default:', e);
                    }
                }).catch(err => {
                    console.error('One or more charts failed to render:', err);
                    if (toggleButton) toggleButton.style.display = 'none';
                    if (activityChartContainer) activityChartContainer.style.display = 'none';
                    if (financialRatioChartContainer) financialRatioChartContainer.style.display = 'none';
                    if (ratiosChartContainer) ratiosChartContainer.style.display = 'none'; // Hide new chart on error
                    if (scatterChartContainer) scatterChartContainer.style.display = 'none'; // Hide scatter chart on error
                });
            } else {
                if (toggleButton) toggleButton.style.display = 'none';
                console.error('No charts were initialized, cannot render.');
                // Ensure all chart containers are hidden if any object fails to initialize
                if(activityChartContainer) activityChartContainer.style.display = 'none';
                if(financialRatioChartContainer) financialRatioChartContainer.style.display = 'none';
                if(ratiosChartContainer) ratiosChartContainer.style.display = 'none';
                if(scatterChartContainer) scatterChartContainer.style.display = 'none';
            }

            if (toggleButton) {
                toggleButton.addEventListener('click', function() {
                    const areChartsCurrentlyVisible = activityChartContainer && activityChartContainer.style.display === 'block';
                    setViewVisibility(!areChartsCurrentlyVisible);
                });
            }

        } else {
            console.log('Chart data is invalid or has no years. Hiding button and charts.');
            if (toggleButton) toggleButton.style.display = 'none';
            if (activityChartContainer) activityChartContainer.style.display = 'none';
            if (financialRatioChartContainer) financialRatioChartContainer.style.display = 'none';
            if (ratiosChartContainer) ratiosChartContainer.style.display = 'none';
            if (scatterChartContainer) scatterChartContainer.style.display = 'none';
        }
    });
</script>

{% endblock content %}