{% extends "Pricing/base_enh.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% block content %}
    <main class="page landing-page">
        <section class="clean-block clean-info dark">
            <div class="container">
                <div class="block-heading" style="display: flex; align-items: center; justify-content: space-between;">
                    <h4 style="margin-right: 20px;font-weight: bolder; color: #0a53be">Marketing / Sales Report</h4>
                    <form method="POST" style="margin-left: auto; margin-right: 10px;">
                        {% csrf_token %}
                        <input class="btn btn-outline-dark btn-lg action-button" type="Submit" name="Back to Dashboard" value="Back to Dashboard">
                    </form>
                </div>
                {% if not has_financial_data %}
                    <div class="block-heading" style="text-align: left">
                        <p>Marketing / Sales data processing not yet complete.  Please await notification in the Message Centre.</p>
                    </div>
                {% endif %}
                {% if has_financial_data %}
                        <div style="padding-left: 20px;  margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <form method="GET" action="" style="display: flex; align-items: center;">
                                    <div style="margin-right: 15px; width: auto;">
                                        <label for="year" style="margin-right: 5px;">Latest Year for Display:</label>
                                    </div>
                                    <div style="margin-right: 15px; ">
                                        <select id="year" name="year">
                                            {% for year in unique_years %}
                                                <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <input type="submit" value="Select" class="btn btn-primary btn-sm">
                                </form>
                                <!-- Button default state: Table visible, button prompts to show chart -->
                                <button id="toggleViewBtn" class="btn btn-outline-warning btn-sm">Show Chart</button>
                            </div>
                            <hr>
                            <div class="mktgsales-data-table" style="{{ initial_table_style|default:'display: block' }};">
                                {{ financial_data_table|safe }}
                            </div>
                            <div id="activityChart" style="{{ initial_chart_style|default:'display: none' }};"></div>
                            <div id="financialRatioChart" style="{{ initial_chart_style|default:'display: none' }}; margin-top: 20px;"></div>
                            <div id="ratiosChart" style="{{ initial_chart_style|default:'display: none' }}; margin-top: 20px;"></div>
                        </div>

                {% endif %}
            </div>
        </section>
    </main>
 {{ chart_data|json_script:"chartDataJson" }}
 <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
 <script>
    console.log("MktgSales Report SCRIPT START");
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded event fired.");
        // Select all table rows within the financial-data-table
        var tableRows = document.querySelectorAll('.mktgsales-data-table tr');

        // Loop through each table row
        tableRows.forEach(function(row) {
            // Select all th and td elements in the current row
            var cells = row.querySelectorAll('th, td');

            // Loop through each cell
            cells.forEach(function(cell) {
                // Check if the cell is empty
                if(cell.innerHTML.trim() === '') {
                    // If empty, insert a non-breaking space character
                    cell.innerHTML = '&nbsp;';
                }

                // Apply the monospaced font to each cell
                cell.style.fontFamily = "'Roboto Mono', monospace";  // Replace 'Roboto Mono' with your chosen font
            });
        });

        // Chart and Toggle Logic
        const toggleButton = document.getElementById('toggleViewBtn');
        const tableContainer = document.querySelector('.mktgsales-data-table');
        const activityChartContainer = document.getElementById('activityChart'); 
        const financialRatioChartContainer = document.getElementById('financialRatioChart'); 
        const ratiosChartContainer = document.getElementById('ratiosChart'); // New chart container

        let isNoviceGame = false;
        try {
            isNoviceGame = JSON.parse("{{ is_novice_game|yesno:'true,false,null' }}");
        } catch (e) {
            console.error('Error parsing is_novice_game:', e);
        }

        let chartData = null;
        const chartDataElement = document.getElementById('chartDataJson');
        if (chartDataElement) {
            try {
                chartData = JSON.parse(chartDataElement.textContent);
            } catch (e) {
                console.error('Error parsing chart_data from json_script:', e);
                if (toggleButton) toggleButton.style.display = 'none';
                if (activityChartContainer) activityChartContainer.style.display = 'none';
                if (financialRatioChartContainer) financialRatioChartContainer.style.display = 'none';
                if (ratiosChartContainer) ratiosChartContainer.style.display = 'none';
                return;
            }
        } else if ("{{chart_data}}" === "None" || "{{chart_data}}" === "") {
             console.log('chart_data was None or empty in Django context, chartData will remain null.');
        }

        // Placeholder for OSFI failure data - this should be populated from your Django view
        // Example structure: {'2023': ['CompanyA', 'CompanyB'], '2022': ['CompanyC']}
        let osfiFailureData = {}; 
        const osfiDataElement = document.getElementById('osfiFailureDataJson');
        if (osfiDataElement) {
            try {
                osfiFailureData = JSON.parse(osfiDataElement.textContent);
            } catch (e) {
                console.error('Error parsing osfi_failure_data from json_script:', e);
                // Decide if you want to hide charts or just proceed without OSFI annotations
            }
        }

        function setButtonState(showChart) {
            if (toggleButton) {
                if (showChart) {
                    toggleButton.textContent = 'Show Table';
                    toggleButton.classList.remove('btn-outline-warning');
                    toggleButton.classList.add('btn-primary');
                } else {
                    toggleButton.textContent = 'Show Chart';
                    toggleButton.classList.remove('btn-primary');
                    toggleButton.classList.add('btn-outline-warning');
                }
            }
        }

        if (isNoviceGame) {
            console.log('Novice game: Initial HTML should reflect chart-first view.');
            setButtonState(true);
        } else {
            console.log('Non-novice game: Initial HTML should reflect table-first view.');
            setButtonState(false); 
        }

        if (chartData && chartData.years && chartData.years.length > 0) {
            console.log('Chart data is valid. Proceeding with chart setup.');

            // Helper function to calculate Y-axis max with padding
            function getAxisMax(dataArray, paddingPercent = 0.1) {
                if (!dataArray || dataArray.length === 0) return undefined; 
                const numericArray = dataArray.map(val => Number(val)).filter(val => !isNaN(val));
                if (numericArray.length === 0) return undefined;
                const maxVal = Math.max(...numericArray);
                return maxVal * (1 + paddingPercent);
            }
            
            // Calculate max values for Y-axes - REORGANIZED
            const customersMaxChart1 = getAxisMax(chartData.customers);
            const avgPremiumMaxChart1 = getAxisMax(chartData.average_premium);
            // const cancellationsMaxChart1 = getAxisMax(chartData.cancellations); // No longer needed for chart 1

            const mktgSpendPercentMaxChart2 = getAxisMax(chartData.marketing_spend_percent_industry);
            // const quotesMaxChart2 = getAxisMax(chartData.quotes); // Will be part of activityCountsMaxChart2
            // const salesMaxChart2 = getAxisMax(chartData.sales); // Will be part of activityCountsMaxChart2
            const activityCountsMaxChart2 = getAxisMax([...(chartData.quotes || []), ...(chartData.sales || []), ...(chartData.cancellations || [])]); // Added cancellations

            // Max values for Chart 3 (Ratios)
            const avgPremiumMaxChart3 = getAxisMax(chartData.average_premium);
            const cancellationRateMaxChart3 = getAxisMax(chartData.cancellation_rate);
            const salesRatioMaxChart3 = getAxisMax(chartData.sales_ratio);
            const percentRatioMaxChart3 = getAxisMax([...(chartData.cancellation_rate || []), ...(chartData.sales_ratio || [])]);

            const commonXAxis = {
                categories: chartData.years,
                title: { text: 'Year' }
            };
            
            const commonChartProps = {
                height: 350,
                type: 'line',
                toolbar: { show: true },
                group: 'mktgSalesCharts' // Synchronization group
            };

            // --- Chart 1: Activity Metrics (Customers, Average Premium) ---
            var options1 = {
                series: [{
                    name: 'Customers', type: 'line', data: chartData.customers
                }, {
                    name: 'Average Premium', type: 'line', data: chartData.average_premium
                }/*, { // Removed Cancellations
                    name: 'Cancellations', type: 'line', data: chartData.cancellations
                }*/],
                chart: commonChartProps,
                colors: ['#00E396', '#FF0000'/*, '#5400E0'*/], // Green (Cust), Red (Avg Prem) - Removed Purple (Canx)
                stroke: { width: [3, 3/*, 2*/], curve: 'smooth' }, // Removed width for Cancellations
                title: { text: 'Customer & Financial Overview' },
                xaxis: commonXAxis,
                yaxis: [
                    {
                        seriesName: 'Customers',
                        title: { text: 'Customers' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? Math.round(value).toLocaleString() : ''; } },
                        tickAmount: 5,
                        min: 0,
                        max: customersMaxChart1
                    },
                    {
                        seriesName: 'Average Premium',
                        opposite: true,
                        title: { text: 'Average Premium ($' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? "$" + Math.round(value).toLocaleString() : ''; } },
                        tickAmount: 5,
                        max: avgPremiumMaxChart1
                    }/*, // Removed Y-axis for Cancellations
                    {
                        seriesName: 'Cancellations',
                        opposite: true,
                        title: { text: 'Cancellations' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? Math.round(value).toLocaleString() : ''; } },
                        tickAmount: 5,
                        min: 0,
                        max: cancellationsMaxChart1,
                        show: true
                    }*/
                ],
                legend: { show: true, position: 'bottom', horizontalAlign: 'center' },
                tooltip: {
                    shared: true, intersect: false,
                    y: {
                        formatter: function (val, { seriesIndex, w }) {
                            const seriesName = w.globals.seriesNames[seriesIndex];
                            if (val === undefined || val === null) return 'N/A';
                            if (seriesName === 'Customers') return Math.round(val).toLocaleString() + " Customers";
                            if (seriesName === 'Average Premium') return "$" + Math.round(val).toLocaleString();
                            // if (seriesName === 'Cancellations') return Math.round(val).toLocaleString() + " Cancellations"; // Removed
                            return Math.round(val).toLocaleString();
                        }
                    }
                }
            };

            // --- Chart 2: Marketing & Sales Activity (Mktg Spend %, Quotes, Sales, Cancellations) ---
            var options2 = {
                series: [{
                    name: 'Mktg Spend (% of Industry)', type: 'column', data: chartData.marketing_spend_percent_industry
                }, {
                    name: 'Quotes', type: 'line', data: chartData.quotes
                }, {
                    name: 'Sales', type: 'line', data: chartData.sales
                }, {
                    name: 'Cancellations', type: 'line', data: chartData.cancellations
                }],
                chart: commonChartProps,
                colors: ['#008FFB', '#00E396', '#FF4560', '#FEB019'], // Mktg:Blue, Quotes:Green, Sales:Red, Canx:Orange
                stroke: { width: [0, 3, 3, 2], curve: 'smooth' },
                title: { text: 'Marketing & Sales Activity' },
                xaxis: commonXAxis,
                yaxis: [
                    {
                        seriesName: ['Quotes', 'Sales', 'Cancellations'],
                        title: { text: 'Quotes / Sales / Cancellations' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? Math.round(value).toLocaleString() : ''; } },
                        tickAmount: 5,
                        min: 0,
                        max: activityCountsMaxChart2
                    },
                    {
                        seriesName: 'Mktg Spend (% of Industry)',
                        opposite: true,
                        title: { text: 'Mktg Spend (% of Industry)' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? value.toFixed(1) + "%" : ''; } },
                        tickAmount: 5,
                        max: mktgSpendPercentMaxChart2
                    }
                ],
                legend: { show: true, position: 'bottom', horizontalAlign: 'center', itemMargin: { horizontal: 5, vertical: 0 } },
                tooltip: {
                    shared: true, intersect: false,
                    y: {
                        formatter: function (val, { seriesIndex, w }) {
                            const seriesName = w.globals.seriesNames[seriesIndex];
                            if (val === undefined || val === null) return 'N/A';
                            if (seriesName === 'Mktg Spend (% of Industry)') return val.toFixed(1) + "%";
                            if (seriesName === 'Quotes') return Math.round(val).toLocaleString() + " Quotes";
                            if (seriesName === 'Sales') return Math.round(val).toLocaleString() + " Sales";
                            if (seriesName === 'Cancellations') return Math.round(val).toLocaleString() + " Cancellations";
                            return Math.round(val).toLocaleString();
                        }
                    }
                },
                annotations: { // Added annotations for OSFI failures
                    xaxis: [] // Will be populated dynamically
                }
            };
            
            // Dynamically add OSFI failure annotations to options2
            if (chartData && chartData.years && Object.keys(osfiFailureData).length > 0) {
                chartData.years.forEach((year, index) => {
                    if (osfiFailureData[year] && osfiFailureData[year].length > 0) {
                        options2.annotations.xaxis.push({
                            x: year, // Category name
                            // y: 0, // Y-coordinate on the y-axis, adjust if needed
                            borderColor: '#FF0000', // Red border for emphasis
                            label: {
                                borderColor: '#FF0000',
                                style: {
                                    color: '#fff', // White text
                                    background: '#FF0000', // Red background
                                    fontSize: '10px',
                                    fontFamily: 'Arial, sans-serif',
                                    cssClass: 'apexcharts-xaxis-annotation-label',
                                },
                                text: 'OSFI Failures: ' + osfiFailureData[year].join(', '),
                                orientation: 'horizontal', // Ensure label is horizontal
                                offsetY: 5, // Position below the x-axis line a bit more
                                position: 'bottom'
                            }
                        });
                    }
                });
            }

            // --- Chart 3: Ratio Analysis ---
            var options3 = {
                series: [{
                    name: 'Average Premium', type: 'line', data: chartData.average_premium
                }, {
                    name: 'Cancellation Rate (%)', type: 'line', data: chartData.cancellation_rate
                }, {
                    name: 'Sales Ratio (%)', type: 'line', data: chartData.sales_ratio
                }],
                chart: commonChartProps, // Re-use common properties
                colors: ['#FF0000', '#00CED1', '#FFD700'], // Red (Avg Prem), Turquoise (Cancel Rate), Gold (Sales Ratio)
                stroke: { width: [3, 2, 2], curve: 'smooth' },
                title: { text: 'Key Performance Ratios' },
                xaxis: commonXAxis,
                yaxis: [
                    {
                        seriesName: 'Average Premium',
                        title: { text: 'Average Premium ($' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? "$" + Math.round(value).toLocaleString() : ''; } },
                        tickAmount: 5,
                        min: 0, // Assuming avg premium should start at 0 for this context, adjust if not
                        max: avgPremiumMaxChart3
                    },
                    {
                        seriesName: ['Cancellation Rate (%)', 'Sales Ratio (%)'],
                        opposite: true,
                        title: { text: 'Rate / Ratio (%)' },
                        labels: { formatter: function (value) { return value !== undefined && value !== null ? value.toFixed(1) + "%" : ''; } },
                        tickAmount: 5,
                        min: 0, // Percentages typically start at 0
                        max: percentRatioMaxChart3 
                    }
                ],
                legend: { show: true, position: 'bottom', horizontalAlign: 'center', itemMargin: { horizontal: 5, vertical: 0 } },
                tooltip: {
                    shared: true, intersect: false,
                    y: {
                        formatter: function (val, { seriesIndex, w }) {
                            const seriesName = w.globals.seriesNames[seriesIndex];
                            if (val === undefined || val === null) return 'N/A';
                            if (seriesName === 'Average Premium') return "$" + Math.round(val).toLocaleString();
                            if (seriesName === 'Cancellation Rate (%)') return val.toFixed(1) + "%";
                            if (seriesName === 'Sales Ratio (%)') return val.toFixed(1) + "%";
                            return val.toLocaleString(); // Fallback, though unlikely needed with explicit series
                        }
                    }
                }
            };

            var chart1 = null;
            if (activityChartContainer) {
                chart1 = new ApexCharts(activityChartContainer, options1);
            }
            var chart2 = null;
            if (financialRatioChartContainer) {
                chart2 = new ApexCharts(financialRatioChartContainer, options2);
            }
            var chart3 = null; // New chart object
            if (ratiosChartContainer) {
                chart3 = new ApexCharts(ratiosChartContainer, options3);
            }

            function setViewVisibility(showCharts) {
                if (showCharts) {
                    if (tableContainer) tableContainer.style.display = 'none';
                    if (activityChartContainer) activityChartContainer.style.display = 'block';
                    if (financialRatioChartContainer) financialRatioChartContainer.style.display = 'block';
                    if (ratiosChartContainer) ratiosChartContainer.style.display = 'block'; // Show new chart
                } else {
                    if (tableContainer) tableContainer.style.display = 'block';
                    if (activityChartContainer) activityChartContainer.style.display = 'none';
                    if (financialRatioChartContainer) financialRatioChartContainer.style.display = 'none';
                    if (ratiosChartContainer) ratiosChartContainer.style.display = 'none'; // Hide new chart
                }
                setButtonState(showCharts);
            }

            if (chart1 && chart2 && chart3) { // Check for chart3 as well
                Promise.all([chart1.render(), chart2.render(), chart3.render()]).then(() => { // Render chart3
                    console.log('All three charts rendered successfully.');
                    try {
                        // chart1.hideSeries('Cancellations'); // Cancellations no longer in chart1
                        chart2.hideSeries('Sales');
                        chart2.hideSeries('Cancellations'); // Hide Cancellations by default in Chart 2
                        // chart3.hideSeries('SeriesNameToHideByDefault'); // If any series in chart3 needs to be hidden by default
                        console.log('Sales and Cancellations (Chart 2) series hidden by default.');
                    } catch (e) {
                        console.error('Error hiding series by default:', e);
                    }
                }).catch(err => {
                    console.error('One or more charts failed to render:', err);
                    if (toggleButton) toggleButton.style.display = 'none';
                    if (activityChartContainer) activityChartContainer.style.display = 'none';
                    if (financialRatioChartContainer) financialRatioChartContainer.style.display = 'none';
                    if (ratiosChartContainer) ratiosChartContainer.style.display = 'none'; // Hide new chart on error
                });
            } else {
                if (toggleButton) toggleButton.style.display = 'none';
                console.error('One or more chart objects not initialized, cannot render.');
                // Ensure all chart containers are hidden if any object fails to initialize
                if(activityChartContainer) activityChartContainer.style.display = 'none';
                if(financialRatioChartContainer) financialRatioChartContainer.style.display = 'none';
                if(ratiosChartContainer) ratiosChartContainer.style.display = 'none';
            }

            if (toggleButton) {
                toggleButton.addEventListener('click', function() {
                    const areChartsCurrentlyVisible = activityChartContainer && activityChartContainer.style.display === 'block';
                    setViewVisibility(!areChartsCurrentlyVisible);
                });
            }

        } else {
            console.log('Chart data is invalid or has no years. Hiding button and charts.');
            if (toggleButton) toggleButton.style.display = 'none';
            if (activityChartContainer) activityChartContainer.style.display = 'none';
            if (financialRatioChartContainer) financialRatioChartContainer.style.display = 'none';
            if (ratiosChartContainer) ratiosChartContainer.style.display = 'none';
        }
    });
</script>

{% endblock content %}
